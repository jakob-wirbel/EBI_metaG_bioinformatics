R version 4.0.3 (2020-10-10) -- "Bunny-Wunnies Freak Out"
Copyright (C) 2020 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

  Natural language support but running in an English locale

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library("tidyverse")
── Attaching packages ────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse 1.3.0 ──
✓ ggplot2 3.3.2     ✓ purrr   0.3.4
✓ tibble  3.0.3     ✓ dplyr   1.0.2
✓ tidyr   1.1.2     ✓ stringr 1.4.0
✓ readr   1.4.0     ✓ forcats 0.5.0
── Conflicts ───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────── tidyverse_conflicts() ──
x dplyr::filter() masks stats::filter()
x dplyr::lag()    masks stats::lag()
> library("SIAMCAT")
Loading required package: mlr
Loading required package: ParamHelpers
'mlr' is in maintenance mode since July 2019. Future development efforts will go into its successor 'mlr3' (<https://mlr3.mlr-org.com>).
Loading required package: phyloseq
> list.files('/home/training/comp_metaG/')
[1] "AT-CRC.motus"        "FR-CRC.motus"        "KEGG_kos_FR-CRC.tsv" "meta_AT-CRC.tsv"     "meta_FR-CRC.tsv"    
> df.meta <- read_tsv('/home/training/comp_metaG/meta_FR-CRC.tsv')

── Column specification ─────────────────────────────────────────────────────────────────────────────────────────────────────
cols(
  Sample_ID = col_character(),
  External_ID = col_character(),
  Age = col_double(),
  Gender = col_character(),
  BMI = col_double(),
  Country = col_character(),
  AJCC_stage = col_character(),
  TNM_stage = col_character(),
  Localization = col_character(),
  Study = col_character(),
  Sampling_rel_to_colonoscopy = col_character(),
  FOBT = col_character(),
  Group = col_character(),
  Library_Size = col_double()
)

> head(df.meta)
# A tibble: 6 x 14
  Sample_ID External_ID   Age Gender   BMI Country AJCC_stage TNM_stage Localization Study Sampling_rel_to… FOBT  Group
  <chr>     <chr>       <dbl> <chr>  <dbl> <chr>   <chr>      <chr>     <chr>        <chr> <chr>            <chr> <chr>
1 CCIS0014… FR-726         72 F         25 FRA     NA         NA        NA           FR-C… BEFORE           Nega… CTR  
2 CCIS0028… FR-060         53 M         32 FRA     NA         NA        NA           FR-C… BEFORE           Nega… CTR  
3 CCIS0212… FR-568         35 M         23 FRA     NA         NA        NA           FR-C… BEFORE           Nega… CTR  
4 CCIS0237… FR-828         67 M         28 FRA     I          T1N0M0    RC           FR-C… BEFORE           Posi… CRC  
5 CCIS0285… FR-027         74 M         27 FRA     NA         NA        NA           FR-C… BEFORE           Posi… CTR  
6 CCIS0347… FR-192         29 M         24 FRA     NA         NA        NA           FR-C… BEFORE           Nega… CTR  
# … with 1 more variable: Library_Size <dbl>
> table(df.meta$Group)

ADA CRC CTR NAA 
 15  53  61  27 
> df.meta <- df.meta %>% filter(Group %in% c('CRC', 'CTR'))
> table(df.meta$Group)

CRC CTR 
 53  61 
> df.meta <- as.data.frame(df.meta)
> rownames(df.meta) <- df.meta$Sample_ID
> fn.feat.fr <- '/home/training/comp_metaG/FR-CRC.motus'
> tax.profiles <- read.table(fn.feat.fr, sep = '\t', quote = '', 
+                            comment.char = '', skip = 61, 
+                            stringsAsFactors = FALSE, check.names = FALSE, 
+                            row.names = 1, header = TRUE)
> dim(tax.profiles)
[1] 14213   156
> tax.profiles[1:3, 1:3]
                                                            CCIS27304052ST-3-0 CCIS13047523ST-4-0 CCIS15794887ST-4-0
'Candidatus Kapabacteria' thiocyanatum [ref_mOTU_v25_10354]                  0                  0                  0
-1                                                                         446                569                383
Abiotrophia defectiva [ref_mOTU_v25_04788]                                   0                  1                  0
> tax.profiles <- as.matrix(tax.profiles)
> rel.tax.profiles <- prop.table(tax.profiles, 2)
> rel.tax.profiles[1:3, 1:3]
                                                            CCIS27304052ST-3-0 CCIS13047523ST-4-0 CCIS15794887ST-4-0
'Candidatus Kapabacteria' thiocyanatum [ref_mOTU_v25_10354]          0.0000000       0.000000e+00          0.0000000
-1                                                                   0.0737312       4.518024e-02          0.0502361
Abiotrophia defectiva [ref_mOTU_v25_04788]                           0.0000000       7.940289e-05          0.0000000
> 
> dim(tax.profiles)
[1] 14213   156
> dim(df.meta)
[1] 114  14
> rel.tax.profiles <- rel.tax.profiles[,df.meta$Sample_ID]
> dim(rel.tax.profiles)
[1] 14213   114
> 
> species.max.value <- apply(rel.tax.profiles, 1, max)
> head(species.max.value)
'Candidatus Kapabacteria' thiocyanatum [ref_mOTU_v25_10354]                                                          -1 
                                               0.0000000000                                                0.2487238979 
                 Abiotrophia defectiva [ref_mOTU_v25_04788]                      Absiella dolichum [ref_mOTU_v25_03694] 
                                               0.0003652968                                                0.0036441317 
                Acaricomes phytoseiuli [ref_mOTU_v25_06702]                   Acaryochloris marina [ref_mOTU_v25_10941] 
                                               0.0000000000                                                0.0000000000 
> hist(log10(species.max.value), 100)
> f.idx <- which(species.max.value > 1e-03)
> rel.tax.profiles.filt <- rel.tax.profiles[f.idx,]
> dim(rel.tax.profiles.filt)
[1] 1074  114
> 
> 
> 
> 
> p.vals <- rep_len(1, nrow(rel.tax.profiles.filt))
> names(p.vals) <- rownames(rel.tax.profiles.filt)
> head(p.vals)
                                             -1          Absiella dolichum [ref_mOTU_v25_03694] 
                                              1                                               1 
   Acetobacter sp. CAG:977 [ref_mOTU_v25_07582]            Acetobacter sp. [ref_mOTU_v25_03587] 
                                              1                                               1 
Acidaminococcus fermentans [ref_mOTU_v25_03588]  Acidaminococcus intestini [ref_mOTU_v25_01949] 
                                              1                                               1 
> for (i in rownames(rel.tax.profiles.filt)){
+     x <- rel.tax.profiles.filt[i,]
+     y <- df.meta$Group
+     t <- wilcox.test(x~y)
+     p.vals[i] <- t$p.value
+ }
> head(p.vals)
                                             -1          Absiella dolichum [ref_mOTU_v25_03694] 
                                      0.3816271                                       0.2537960 
   Acetobacter sp. CAG:977 [ref_mOTU_v25_07582]            Acetobacter sp. [ref_mOTU_v25_03587] 
                                      0.1896722                                       0.7562352 
Acidaminococcus fermentans [ref_mOTU_v25_03588]  Acidaminococcus intestini [ref_mOTU_v25_01949] 
                                      0.3972054                                       0.0782442 
> head(sort(p.vals))
Fusobacterium nucleatum subsp. animalis [ref_mOTU_v25_01001]                  Dialister pneumosintes [ref_mOTU_v25_03630] 
                                                1.072932e-07                                                 5.047528e-06 
                   Hungatella hathewayi [ref_mOTU_v25_03436]           Olsenella sp. Marseille-P2300 [ref_mOTU_v25_10001] 
                                                3.079069e-05                                                 2.283988e-04 
                        Clostridium sp. [ref_mOTU_v25_03680]                   [Eubacterium] eligens [ref_mOTU_v25_02375] 
                                                2.756465e-04                                                 3.395879e-04 
> species <- 'Fusobacterium nucleatum subsp. animalis [ref_mOTU_v25_01001]'
> df.plot <- tibble(fuso=rel.tax.profiles.filt[species,], label=df.meta$Group)
> 
> head(df.plot)
# A tibble: 6 x 2
      fuso label
     <dbl> <chr>
1 0        CTR  
2 0        CTR  
3 0        CTR  
4 0.000698 CRC  
5 0        CTR  
6 0        CTR  
> df.plot %>% ggplot(aes(x=label, y=fuso)) + geom_boxplot() + xlab('')
> df.plot %>% ggplot(aes(x=label, y=log10(fuso + 1e-05))) + geom_boxplot() + xlab('')
> df.plot %>% ggplot(aes(x=label, y=log10(fuso + 1e-05))) + geom_boxplot() + geom_jitter(width = 0.08) + xlab('')
> 
> 
> 
> 
> library('SIAMCAT')
> 
> 
> sc.obj <- siamcat(feat=rel.tax.profiles, meta=df.meta, label='Group', case='CRC')
+ starting create.label
Label used as case:
   CRC
Label used as control:
   CTR
+ finished create.label.from.metadata in 0.026 s
+ starting validate.data
+++ checking overlap between labels and features
+ Keeping labels of 114 sample(s).
+++ checking sample number per class
+++ checking overlap between samples and metadata
+ finished validate.data in 0.582 s
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> 
> 
> 
> 
> sc.obj <- filter.features(sc.obj, filter.method = 'abundance', cutoff=1e-03)
Features successfully filtered
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples
filt_feat()            Filtered features:    1073 features after abundance filtering

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> dim(rel.tax.profiles.filt)
[1] 1074  114
> sc.obj <- check.associations(sc.obj, detect.lim = 1e-05, fn.plot = './associoations.pdf')
Plotted associations between features and label successfully to: ./associoations.pdf                                       
Warning message:
In get.plotting.idx(result.list$effect.size, alpha = alpha, sort.by = sort.by,  :
  Less than 5 associations found. Consider changing your alpha value.
> 
> 
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples
filt_feat()            Filtered features:    1073 features after abundance filtering
associations()         Associations:         Results from association testing
                                             with 3 significant features at alpha 0.05

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> head(associations(sc.obj))
                                                             fc     p.val       auc  auc.ci.l  auc.ci.h     pr.shift
Absiella dolichum [ref_mOTU_v25_03694]            -0.1172383667 0.2537960 0.4633467 0.4018807 0.5248127 -0.069594804
Acetobacter sp. CAG:977 [ref_mOTU_v25_07582]       0.0000000000 0.1896722 0.4836066 0.4610769 0.5061362 -0.032786885
Acetobacter sp. [ref_mOTU_v25_03587]               0.0001785261 0.7562352 0.4896381 0.4252832 0.5539930 -0.015465512
Acidaminococcus fermentans [ref_mOTU_v25_03588]    0.0764996038 0.3972054 0.5279926 0.4626653 0.5933199  0.055057222
Acidaminococcus intestini [ref_mOTU_v25_01949]     0.2277373719 0.0782442 0.5661924 0.4920953 0.6402895  0.133003402
Acidaminococcus massiliensis [ref_mOTU_v25_03590]  0.0000000000 0.8591202 0.4958243 0.4513974 0.5402513 -0.008969997
                                                        pr.n       pr.p      bcol     p.adj
Absiella dolichum [ref_mOTU_v25_03694]            0.16393443 0.09433962 #31369585 0.6550675
Acetobacter sp. CAG:977 [ref_mOTU_v25_07582]      0.03278689 0.00000000 #31369585 0.5985832
Acetobacter sp. [ref_mOTU_v25_03587]              0.14754098 0.13207547 #31369585 0.9428565
Acidaminococcus fermentans [ref_mOTU_v25_03588]   0.11475410 0.16981132 #A5002685 0.7181414
Acidaminococcus intestini [ref_mOTU_v25_01949]    0.13114754 0.26415094 #A5002685 0.4327630
Acidaminococcus massiliensis [ref_mOTU_v25_03590] 0.06557377 0.05660377 #31369585 0.9644237
> df.assoc <- associations(sc.obj)
> df.assoc %>% ggplot(aes(x=fc, y=-log10(p.adj))) + geom_point()
> df.assoc %>% ggplot(aes(x=fc, y=-log10(p.adj))) + geom_point() + xlab('Generalized Fold Change')
> 
> 
> 
> 
> sc.obj <- normalize.features(sc.obj, norm.method = 'log.std', norm.param = list(log.n0=1e-05, sd.min.q=0))
Features normalized successfully.
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples
filt_feat()            Filtered features:    1073 features after abundance filtering
associations()         Associations:         Results from association testing
                                             with 3 significant features at alpha 0.05
norm_feat()            Normalized features:  1073 features normalized using log.std

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> sc.obj <- create.data.split(sc.obj, num.folds = 5, num.resample = 5)
Features splitted for cross-validation successfully.
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples
filt_feat()            Filtered features:    1073 features after abundance filtering
associations()         Associations:         Results from association testing
                                             with 3 significant features at alpha 0.05
norm_feat()            Normalized features:  1073 features normalized using log.std
data_split()           Data split:           5 cv rounds with 5 folds

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> sc.obj <- train.model(sc.obj, method='lasso')
Trained lasso models successfully.                                                                                          
> sc.obj <- make.predictions(sc.obj)
Made predictions successfully.                                                                                              
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples
filt_feat()            Filtered features:    1073 features after abundance filtering
associations()         Associations:         Results from association testing
                                             with 3 significant features at alpha 0.05
norm_feat()            Normalized features:  1073 features normalized using log.std
data_split()           Data split:           5 cv rounds with 5 folds
model_list()           Model list:           25 lasso models
feature_weights()      Feature weights:      Summary of feature weights [ see also weight_matrix() ]
pred_matrix()          Prediction matrix:    Predictions for 114 samples from 5 cv rounds

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> head(pred_matrix(sc.obj))
                     CV_rep1   CV_rep2   CV_rep3   CV_rep4   CV_rep5
CCIS00146684ST-4-0 0.2121058 0.4563487 0.5813921 0.1371255 0.3105651
CCIS00281083ST-3-0 0.2678504 0.1726102 0.3398451 0.2370572 0.3532839
CCIS02124300ST-4-0 0.3469536 0.2956631 0.3878586 0.2879094 0.3352002
CCIS02379307ST-4-0 0.7707677 0.7452401 0.8723678 0.9298546 0.7663432
CCIS02856720ST-4-0 0.2466633 0.2011028 0.3139991 0.3062334 0.2502935
CCIS03473770ST-4-0 0.1872715 0.1507928 0.1914681 0.1679982 0.1532296
> sc.obj <- evaluate.predictions(sc.obj)
Evaluated predictions successfully.
> sc.obj
siamcat-class object
label()                Label object:         61 CTR and 53 CRC samples
filt_feat()            Filtered features:    1073 features after abundance filtering
associations()         Associations:         Results from association testing
                                             with 3 significant features at alpha 0.05
norm_feat()            Normalized features:  1073 features normalized using log.std
data_split()           Data split:           5 cv rounds with 5 folds
model_list()           Model list:           25 lasso models
feature_weights()      Feature weights:      Summary of feature weights [ see also weight_matrix() ]
pred_matrix()          Prediction matrix:    Predictions for 114 samples from 5 cv rounds
eval_data()            Evaluation data:      Average AUC: 0.84

contains phyloseq-class experiment-level object @phyloseq:
phyloseq@otu_table()   OTU Table:            [ 14213 taxa and 114 samples ]
phyloseq@sam_data()    Sample Data:          [ 114 samples by 13 sample variables ]
> model.evaluation.plot(sc.obj)
Hit <Return> to see next plot: 
Hit <Return> to see next plot: 
> 
> head(feature_weights(sc.obj))
                                                  mean.weight median.weight sd.weight mean.rel.weight median.rel.weight
Absiella dolichum [ref_mOTU_v25_03694]                      0             0         0               0                 0
Acetobacter sp. CAG:977 [ref_mOTU_v25_07582]                0             0         0               0                 0
Acetobacter sp. [ref_mOTU_v25_03587]                        0             0         0               0                 0
Acidaminococcus fermentans [ref_mOTU_v25_03588]             0             0         0               0                 0
Acidaminococcus intestini [ref_mOTU_v25_01949]              0             0         0               0                 0
Acidaminococcus massiliensis [ref_mOTU_v25_03590]           0             0         0               0                 0
                                                  sd.rel.weight percentage
Absiella dolichum [ref_mOTU_v25_03694]                        0          0
Acetobacter sp. CAG:977 [ref_mOTU_v25_07582]                  0          0
Acetobacter sp. [ref_mOTU_v25_03587]                          0          0
Acidaminococcus fermentans [ref_mOTU_v25_03588]               0          0
Acidaminococcus intestini [ref_mOTU_v25_01949]                0          0
Acidaminococcus massiliensis [ref_mOTU_v25_03590]             0          0
> model.interpretation.plot(sc.obj, fn.plot = './model_interpration.pdf')
Successfully plotted model interpretation plot to: ./model_interpration.pdf
